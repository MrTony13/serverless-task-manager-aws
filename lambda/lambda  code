import { DynamoDBClient } from "@aws-sdk/client-dynamodb";
import {
  DynamoDBDocumentClient,
  PutCommand,
  ScanCommand,
  UpdateCommand,
  DeleteCommand
} from "@aws-sdk/lib-dynamodb";
import crypto from "crypto";

const client = new DynamoDBClient({});
const ddb = DynamoDBDocumentClient.from(client);

const TABLE_NAME = process.env.TABLE_NAME;

export const handler = async (event) => {
  const method = event.httpMethod;

  try {
    // GET all tasks
    if (method === "GET") {
      const data = await ddb.send(
        new ScanCommand({ TableName: TABLE_NAME })
      );
      return response(200, data.Items || []);
    }

    // CREATE task
    if (method === "POST") {
      const body = JSON.parse(event.body || "{}");

      const item = {
        taskid: crypto.randomUUID(),
        title: body.title || "Untitled Task",
        status: "created",
        createdAt: new Date().toISOString()
      };

      await ddb.send(
        new PutCommand({
          TableName: TABLE_NAME,
          Item: item
        })
      );

      return response(201, item);
    }

    // UPDATE task
    if (method === "PUT") {
      const body = JSON.parse(event.body || "{}");

      await ddb.send(
        new UpdateCommand({
          TableName: TABLE_NAME,
          Key: { taskid: body.taskid },
          UpdateExpression: "SET title = :t, #s = :s",
          ExpressionAttributeNames: {
            "#s": "status"
          },
          ExpressionAttributeValues: {
            ":t": body.title,
            ":s": body.status
          }
        })
      );

      return response(200, { message: "Task updated" });
    }

    // DELETE task
    if (method === "DELETE") {
      const body = JSON.parse(event.body || "{}");

      await ddb.send(
        new DeleteCommand({
          TableName: TABLE_NAME,
          Key: { taskid: body.taskid }
        })
      );

      return response(200, { message: "Task deleted" });
    }

    return response(400, { message: "Unsupported method" });

  } catch (error) {
    console.error(error);
    return response(500, { error: error.message });
  }
};

const response = (statusCode, body) => ({
  statusCode,
  headers: {
    "Access-Control-Allow-Origin": "*",
    "Access-Control-Allow-Headers": "Authorization,Content-Type",
    "Access-Control-Allow-Methods": "GET,POST,PUT,DELETE,OPTIONS"
  },
  body: JSON.stringify(body)
});
